<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/lib/utils/boot.html">
<link rel="import" href="../polymer/lib/utils/mixin.html">
<link rel="import" href="properties-changed.html">

<script>
(function() {
  'use strict';

  /**
   * Mixin that provides minimal starting point to using the PropertiesChanged
   * mixin by providing a mechanism to declare properties in a static
   * getter (e.g. static get properties() { return { foo: String } }). Changes
   * are reported via the `_propertiesChanged` method.
   *
   * This mixin provides no specific support for rendering. Users are expected
   * to create a shadowRoot and put content into it and update it in whatever
   * way makes sense for the use case.
   *
   * @customElement
   * @polymer
   * @memberof Polymer
   * @constructor
   * @implements {Polymer_PropertiesChanged}
   * @extends HTMLElement
   * @appliesMixin Polymer.PropertiesChanged
   * @summary Mixin that provides a minimal starting point for using
   * the PropertiesChanged mixin by providing a declarative `properties` object.
   */
   Polymer.PropertiesMixin = Polymer.dedupingMixin(superClass => {

    /**
     * @constructor
     * @extends {superClass}
     * @implements {Polymer_PropertiesChanged}
     * @unrestricted
     */
    const base = Polymer.PropertiesChanged(superClass);

    return class PropertiesElement extends base {

      /**
       * Implements standard custom elements getter to observes the attributes
       * listed in `properties`.
       */
      static get observedAttributes() {
        const props = this.properties;
        return props ? Object.keys(props).map(p => {
          return this.prototype._attributeForProperty(p);
        }) : [];
      }

      static _ensureFinalized(name) {
        const proto = this.prototype;
        if (!proto.hasOwnProperty('__finalized')) {
          proto.__finalized = true;
          this.finalize(name);
        }
      }

      /**
       * Finalizes an element definition. This includes ensuring property
       * accessors exist on the element prototype and parsing the element
       * template.
       * @param {string} name Name of the element
       */
      static finalize(name) { // eslint-disable-line no-unused-vars
        const props = this.properties;
        if (props) {
          this.prototype.__propertyInfo = props;
          this.createProperties(Object.keys(props));
        }
      }

      /**
       * Overrides implementation in PropertiesChanged to immediately process
       * any pending changes to properties and ensure that
       * `_propertiesChanged` is called.
       *
       * @public
       */
      ready() {
        super.ready();
        this._invalidateProperties();
        this._validateProperties();
      }

      /**
       * Overrides default behavior and adds a call to `finalize` which lazily
       * configures the element's property accessors.
       * @override
       */
      _initializeProperties() {
        this.constructor._ensureFinalized(this.localName);
        super._initializeProperties();
      }

      /**
       * Overrides PropertiesChanged method to return type specified in the
       * static `properties` object for the given property.
       * @param {string} name Name of property
       * @return {*} Type to which to deserialize attribute
       *
       * @protected
       */
      _typeForProperty(name) {
        const props = this.__propertyInfo;
        return props && props[name];
      }

      /**
       * Called when the element is added to a document.
       * Calls `_enableProperties` to turn on property system from
       * `PropertiesChanged`.
       */
      connectedCallback() {
        this._enableProperties();
      }

      /**
       * Called when the element is removed from a document
       */
      disconnectedCallback() {}

    };

  });

})();

</script>